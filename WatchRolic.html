<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Просмотр ролика</title>
    <style>
        #inputBox {
            position: absolute;
            left: 50px;
            top: 50px;
            width: 300px;
            height: 150px;
            padding: 15px;
            background-color: #CCCCCC;
            border: 1px solid black;
        }

        #rolicBox {
            position: absolute;
            left: 50px;
            top: 250px;
            width: 300px;
            height: 250px;
            background-color: #CCCCCC;
            padding: 0px;
            border: 1px solid black;
        }

        .canvasImage {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

<div id = "inputBox">
    <p>Ролик в формате JSON</p>
    <textarea id = "inpField"></textarea>
    <br>
    <br>
    <button id = "startBtn">Просмотр</button>
</div>

<div id = "rolicBox"></div>

<script>
    window.onload = function() {
        document.getElementById("startBtn").onclick = function() {
            console.log("Start");
            console.log("---------------------------------");

            const rolicBox = document.getElementById("rolicBox");

            const contentText = document.getElementById("inpField").value;

            const obj = JSON.parse(contentText);

            const imagesArr = obj.answer;
            rolicBox.style.backgroundColor = obj.fonColor;
            rolicBox.style.width = obj.fonWidth;
            rolicBox.style.height = obj.fonHeight;

            const lastFrame = parseInt(obj.lastFrame);
            console.log("lastFrame: " + lastFrame);

            console.log("Rolic: " + rolicBox.style.backgroundColor + "  " + rolicBox.style.width + "  " + rolicBox.style.height);


            for(let i = 0; i < imagesArr.length; i++) {
                const image = imagesArr[i];
                const count = image.name;

                let textHtml = "<div id = 'picture_box_" + count + "' style = 'position: absolute; padding: 0px; height: 150px; width: 150px; margin-left: 0px; margin-top: 0px;'></div>";
                rolicBox.innerHTML += textHtml;
                document.getElementById("picture_box_" + count).innerHTML = "<img src = '" + image.content + "' class = 'canvasImage'>";
            }

            /********************************************************************/

            function changeProperties(currentImage, now, after) {
                const frameNumber = after - now - 1;

                if(frameNumber !== 0) {

                    const valuesArr = [
                        "x", "y", "w", "h",
                    ];

                    for(let ind = 0; ind < valuesArr.length; ind++) {
                        const value = valuesArr[ind];

                        const dx = (currentImage.frames[after][value] - currentImage.frames[now][value]) / frameNumber;
                        let nowValue = currentImage.frames[now][value];

                        for (let i = now + 1; i <= after - 1; i++) {
                            nowValue += dx;
                            currentImage.frames[i][value] = parseInt(nowValue);
                        }
                    }
                }
            }

            for(let qqq = 0; qqq < imagesArr.length; qqq++) {
                const currentImage = imagesArr[qqq];

                for (let i = 0; i < currentImage.frames.length; i++) {
                    const frameNow = currentImage.frames[i];
                    if (frameNow.marked === true) {
                        const now = i;

                        for (let j = now + 1; j < currentImage.frames.length; j++) {
                            const frameAfter = currentImage.frames[j];
                            if (frameAfter.marked === true) {
                                const after = j;
                                changeProperties(currentImage, now, after);
                                i = after - 1;
                                break;
                            }
                        }
                    }
                }
            }

            /********************************************************************/

            let now = 0;

            let inter = setInterval(() => {
                for(let i = 0; i < imagesArr.length; i++) {
                    const image = imagesArr[i];

                    const frame = image.frames[now];
                    const count = image.name;

                    const box = document.getElementById("picture_box_" + count);

                    box.style.marginLeft = frame.x + "px";
                    box.style.marginTop = frame.y + "px";
                    box.style.width = frame.w + "px";
                    box.style.height = frame.h + "px";

                    now++;

                    if(now === lastFrame) {
                        clearInterval(inter);
                        document.getElementById("startBtn").click();
                    }
                }
            }, 50);
        }
    }
</script>

</body>
</html>